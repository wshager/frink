{"version":3,"sources":["../src/type.js"],"names":["operatorMap","generalOperatorMap","Object","assign","String","prototype","compProto","Float","opProto","Number","Boolean","asType","cc","ifEmpty","prep","id","a","decimal","Decimal","integer","Integer","string","data","number","NaN","float","double","castAs","b","to","$a","$b","call","f","_op","op","invert","ret","undefined","_promote","c","constructor","d","UntypedAtomic","toString","generalComp","opfn","x","and","impl","or","logic","not","opinv","ne","operator","comp","general","hasOp","operatorName","hasOwnProperty","bind","md","node","type","nodeData"],"mappings":"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","sourcesContent":["import Decimal from \"big.js\";\r\n\r\nimport Integer from \"./types/integer\";\r\n\r\nimport Float from \"./types/float\";\r\n\r\nimport UntypedAtomic from \"./types/untyped-atomic\";\r\n\r\nimport opProto from \"./types/op-proto\";\r\n\r\nimport compProto from \"./types/comp-proto\";\r\n\r\nimport { stringJoin } from \"./string/value\";\r\n\r\nimport { error } from \"./error\";\r\n\r\nimport { forEach, filter, range, switchMap, pipe, first } from \"./seq\";\r\n\r\nimport { get as aGet } from \"./array\";\r\n\r\nimport { get as mGet } from \"./map\";\r\n\r\nimport { isUndef, isNull, isList, isMap, id } from \"./util\";\r\n\r\nimport { isVNode, traverse } from \"l3n\";\r\n\r\nimport { boolean, not } from \"./boolean/value\";\r\n\r\nimport * as impl from \"./impl\";\r\n\r\n// TODO complete math (e.g. type checks for idiv and friends)\r\n\r\n// one big pile\r\nexport const operatorMap = {\r\n\t\"+\": \"plus\",\r\n\t\"-\": \"minus\",\r\n\t\"*\": \"times\",\r\n\t\"div\": \"div\",\r\n\t\"/\": \"div\",\r\n\t\"idiv\": \"div\",\r\n\t\"eq\": \"eq\",\r\n\t\"ne\": \"eq\",\r\n\t\"gt\": \"gt\",\r\n\t\"lt\": \"lt\",\r\n\t\"ge\": \"gte\",\r\n\t\"le\": \"gte\",\r\n\t\"&&\": \"and\",\r\n\t\"||\": \"or\",\r\n\t\"!\": \"not\"\r\n};\r\n\r\nexport const generalOperatorMap = {\r\n\t\">\": \"gt\",\r\n\t\"<\": \"lt\",\r\n\t\">=\": \"gte\",\r\n\t\"<=\": \"lte\",\r\n\t\"=\": \"eq\",\r\n\t\"!=\": \"eq\"\r\n};\r\n\r\n// mixin comparators\r\nObject.assign(String.prototype, compProto);\r\n\r\nObject.assign(Float.prototype, compProto, opProto);\r\n\r\nObject.assign(Number.prototype, compProto, opProto);\r\n\r\nObject.assign(Boolean.prototype, compProto);\r\n\r\n// TODO decimal opt-in/out\r\n\r\nconst asType = (cc,ifEmpty,prep = id) => a => isUndef(a) ? cc : isNull(a) ? ifEmpty : cc(prep(a));\r\n\r\n// TODO create from Type classes\r\nexport const decimal = asType(Decimal,null);\r\n\r\nexport const integer = asType(Integer,null);\r\n\r\nexport const string = asType(String,String(),a => isVNode(a) ? data(a) : a);\r\n\r\nexport const number = asType(Number,NaN);\r\n\r\n// 32-bits float\r\nexport const float = asType(Float,NaN);\r\n\r\nexport const double = number;\r\n\r\nexport function castAs(a, b) {\r\n\treturn b(a);\r\n}\r\n\r\nexport function to($a, $b) {\r\n\treturn range($b, $a);\r\n}\r\n\r\nexport function call(f,...a) {\r\n\tif (isList(f)) {\r\n\t\treturn aGet(f,a[0]);\r\n\t} else if (isMap(f)) {\r\n\t\treturn mGet(f,a[0]);\r\n\t} else {\r\n\t\treturn f(...a);\r\n\t}\r\n}\r\n\r\nfunction _op(op, invert, a, b) {\r\n\tvar ret;\r\n\tif (a === undefined || b === undefined) {\r\n\t\treturn error(\"A value may never be undefined\");\r\n\t}\r\n\tif (typeof a[op] == \"function\") {\r\n\t\t[a,b] = _promote(a, b);\r\n\t\tret = a[op](b);\r\n\t} else {\r\n\t\treturn error(\"XPST0017\",\"Operator \" + op + \" not implemented\");\r\n\t}\r\n\treturn invert ? !ret : ret;\r\n}\r\n\r\nfunction _promote(a, b) {\r\n\t// TODO use JS type casting: 1 == \"1\"\r\n\t//If each operand is an instance of one of the types xs:string or xs:anyURI, then both operands are cast to type xs:string.\r\n\t//If each operand is an instance of one of the types xs:decimal or xs:float, then both operands are cast to type xs:float.\r\n\t//If each operand is an instance of one of the types xs:decimal, xs:float, or xs:double, then both operands are cast to type xs:double.\r\n\tvar c = a.constructor,\r\n\t\td = b.constructor;\r\n\tif (c == Number || d == Number) {\r\n\t\tif (c == Integer || c == Decimal || c == Float || c == UntypedAtomic) {\r\n\t\t\ta = +a.toString();\r\n\t\t\tc = Number;\r\n\t\t}\r\n\t\tif (d == Integer || d == Decimal || d == Float || d == UntypedAtomic) {\r\n\t\t\tb = +b.toString();\r\n\t\t\td = Number;\r\n\t\t}\r\n\t}\r\n\tif (c == Integer || d == Integer) {\r\n\t\tif (c == Decimal || c == UntypedAtomic) {\r\n\t\t\ta = c == UntypedAtomic ? new Integer(a.toString()) : a;\r\n\t\t\tc = Integer;\r\n\t\t}\r\n\t\tif (d == Decimal || d == UntypedAtomic) {\r\n\t\t\tb = d == UntypedAtomic ? new Integer(b.toString()) : b;\r\n\t\t\td = Integer;\r\n\t\t}\r\n\t}\r\n\tif (c == String || d == String) {\r\n\t\tif (c == UntypedAtomic) {\r\n\t\t\ta = a.toString();\r\n\t\t\tc = String;\r\n\t\t}\r\n\t\tif (d == UntypedAtomic) {\r\n\t\t\tb = a.toString();\r\n\t\t\td = String;\r\n\t\t}\r\n\t}\r\n\treturn [a, b];\r\n}\r\n\r\nfunction generalComp(opfn, $a, $b) {\r\n\treturn pipe(switchMap(a => forEach(b => opfn(a,b))($b)),first(x => x,false))($a);\r\n}\r\n\r\n\r\n/**\r\n * expect functions\r\n */\r\nexport function and($a, $b) {\r\n\treturn switchMap(boolean($a()), a => a ? switchMap(boolean($b()),impl.and(a)) : false);\r\n}\r\n\r\nexport function or($a, $b) {\r\n\treturn switchMap(boolean($a()), a => a ? true : switchMap(boolean($b()),impl.or(a)));\r\n}\r\n\r\nconst logic = {\r\n\tand: and,\r\n\tor: or,\r\n\tnot: not\r\n};\r\n\r\nconst opinv = {\r\n\tne: true,\r\n\t\"!=\": true\r\n};\r\n\r\n// NOTE cardinality tests should be taken care of by VM\r\nexport function op($a, operator, $b) {\r\n\tvar invert = false,\r\n\t\tcomp = false,\r\n\t\tgeneral = false,\r\n\t\thasOp = false,\r\n\t\toperatorName;\r\n\tvar opfn;\r\n\tif (typeof operator == \"string\") {\r\n\t\tinvert = opinv[operator];\r\n\t\thasOp = operator in operatorMap;\r\n\t\tif(!hasOp){\r\n\t\t\tgeneral = operator in generalOperatorMap;\r\n\t\t\tif(!general) return error(\"xxx\", \"No such operator\");\r\n\t\t\toperatorName = generalOperatorMap[operator];\r\n\t\t} else {\r\n\t\t\toperatorName = operatorMap[operator];\r\n\t\t}\r\n\t\tif (logic[operatorName]) {\r\n\t\t\treturn logic[operatorName]($a, $b);\r\n\t\t} else {\r\n\t\t\tcomp = compProto.hasOwnProperty(operatorName);\r\n\t\t\topfn = _op.bind(null, operatorName, invert);\r\n\t\t}\r\n\t\tif (comp) {\r\n\t\t\tconst md = forEach(data);\r\n\t\t\t$a = md($a);\r\n\t\t\t$b = md($b);\r\n\t\t}\r\n\t} else if (typeof operator == \"function\") {\r\n\t\topfn = operator;\r\n\t} else {\r\n\t\treturn error(\"XPST0017\", \"Unknown operator: \"+operator);\r\n\t}\r\n\tif(general) return generalComp(opfn, $a, $b);\r\n\tif(isNull($a) || isNull($b)) return null;\r\n\treturn opfn($a, $b);\r\n}\r\n\r\nfunction data($a) {\r\n\treturn switchMap($a, a => {\r\n\t\tif(isVNode(a)) {\r\n\t\t\treturn new UntypedAtomic(stringJoin(pipe(filter(node => node.type == 2 || node.type == 3),forEach(node => impl.nodeData(node)))(traverse(a))));\r\n\t\t} else {\r\n\t\t\treturn a;\r\n\t\t}\r\n\t});\r\n}\r\n"],"file":"type.js"}